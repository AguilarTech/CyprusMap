<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" integrity="sha512-wnea99uKIC3TJF7v4eKk4Y+lMz2Mklv18+r4na2Gn1abDRPPOeef95xTzdwGD9e6zXJBteMIhZ1+68QC5byJZw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <title>Transport Map of Cyprus</title>
     <meta name="description" content="Select your journey on the map" />
    <meta property="og:title" content="Transport Map of Cyprus" />
    <meta property="og:url" content="https://aguilartech.io/cyprusmap/" />
    <meta property="og:description" content="Select your journey on the map." />
    <meta property="og:image" content="./favicons/android-chrome-192x192.png" /> 

    <link rel="apple-touch-icon" sizes="180x180" href="./favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicons/favicon-16x16.png">
    <link rel="manifest" href="./favicons/site.webmanifest">


    <script src='https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.css' rel='stylesheet' />

</head>
<body>

  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css" type="text/css">

    <div class="py-12 bg-white">
    <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">

  <div class="relative bg-white overflow-hidden">
    <div class="max-w-7xl mx-auto">
      <div class="relative z-10 pb-8 bg-white sm:pb-16 md:pb-20 lg:max-w-2xl lg:w-full lg:pb-28 xl:pb-32">
        <svg class="hidden lg:block absolute right-0 inset-y-0 h-full w-48 text-white transform translate-x-1/2" fill="currentColor" viewBox="0 0 100 100" preserveAspectRatio="none" aria-hidden="true">
          <polygon points="50,0 100,0 50,100 0,100" />
        </svg>

        <div>
            <div class="relative pt-6 px-4 sm:px-6 lg:px-8">
              <nav class="relative flex items-center justify-between sm:h-10 lg:justify-start" aria-label="Global">
              </nav>
            </div>
        </div>
  
  <main class="mt-2 mx-auto max-w-7xl px-4 sm:mt-2 sm:px-6 md:mt-2 lg:mt-2 lg:px-8 xl:mt-2">
          <div class="sm:text-center lg:text-left">
            <h1 class="text-4xl tracking-tight font-extrabold text-gray-900 sm:text-5xl md:text-6xl">
              <span class="block xl:inline">Cyprus by Bus</span>
            </h1>
            
            <h2 class="text-4xl tracking-tight font-extrabold text-blue-500 sm:text-5xl md:text-6xl">
                <span class="block  xl:inline">Click your route!</span>
             </h2>

            <p class="mt-3 text-base text-gray-500 sm:mt-5 sm:text-lg sm:max-w-xl sm:mx-auto md:mt-5 md:text-xl lg:mx-0">Select your journey on the map</p>
            <div class="mt-5 sm:mt-8 sm:flex sm:justify-center lg:justify-start">
           </div>
          </div>
   </main>
      </div>
    </div>
    <div class="lg:absolute lg:inset-y-0 lg:right-0 lg:w-1/2">
      <img class="h-56 w-full object-cover sm:h-72 md:h-96 lg:w-full lg:h-full" src="mapmen.jpg" alt="Map Men">
    </div>
  </div>

  <div class="flex flex-wrap md:flex-nowrap bg-white shadow-md rounded mt-5 mx-auto max-w-full px-2 sm:mt-12 sm:px-2 md:mt-16 lg:mt-5 lg:px-2 xl:mt-5">
    <form class="flex-auto mt-5 px-5" id="form">
      <img class="mb-5" src="cyprusbybus.jpg" alt="CyprusByBus.com">
      <div class="mb-4">
        <label class="block text-gray-700 text-sm font-bold mb-2" for="from">
          From:
        </label>
        <textarea disabled class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="From" type="text" placeholder="Click map"></textarea>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 text-sm font-bold mb-2" for="To">
          To:
        </label>
        <textarea disabled class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="To" type="text" placeholder="Click map"></textarea>
      </div>
      <div class="mb-5 items-center justify-between rounded-md shadow">
        <button class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit">
          Search CyprusByBus.com
        </button>
      </div>
    </form>

  <div class="mt-5 mb-4" id='map' style='width: 100%; height: 600px;'></div>

</div>
</div>


</div>

<footer class="text-center p-4"><a href="https:/AguilarTech.io" class="px-4 py-1 text-sm text-blue-500 font-semibold rounded-full border border-blue-200 hover:text-white hover:bg-blue-200 hover:border-transparent focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2">Powered by AguilarTech.io</a></footer>
</body>


<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZGFuaWVsYWd1aWxhciIsImEiOiJjanFpdmN5YmkxMHJqNDlsMm9xeXNpMnRrIn0.fE9QBxPaRrtIfk_K_RvNbQ';
const map = new mapboxgl.Map({
container: 'map', // container ID
style: 'mapbox://styles/mapbox/streets-v11', // style URL
center: [33.2872, 34.9447], // starting position [lng, lat]
zoom: 9, // starting zoom
pitch: 10, // pitch in degrees

});

// map.addControl(
// new MapboxDirections({
// accessToken: mapboxgl.accessToken
// }),
// 'top-left'
// );


// Add zoom and rotation controls to the map.
map.addControl(new mapboxgl.NavigationControl());

map.addControl(new mapboxgl.FullscreenControl());

// Add geolocate control to the map.
map.addControl(
    new mapboxgl.GeolocateControl({
    positionOptions: {
    enableHighAccuracy: true
    },
    // When active the map will receive updates to the device's location as it changes.
    trackUserLocation: true,
    // Draw an arrow next to the location dot to indicate which direction the device is heading.
    showUserHeading: true
    })
  );


// map.on('load', () => {

// // Start the animation.
// map.rotateTo(5, {duration: 1000});
// setTimeout(() => { map.rotateTo(355, {duration: 2000}); }, 1000);

// });


// Add a source for the state polygons.
// map.addSource('districts', {
// 'type': 'geojson',
// 'data': 'cyprus.geojson'
// });
 
// Add a layer showing the state polygons.
// map.addLayer({
// 'id': 'districts-layer',
// 'type': 'fill',
// 'source': 'districts',
// 'layout': {},
// "paint": {
//       "fill-color": "#0080ff",
//       "fill-opacity": 0.12,

//     }

// });

// // Add a black outline around the polygons.
// map.addLayer({
// 'id': 'outline',
// 'type': 'line',
// 'source': 'districts',
// 'layout': {},
// 'paint': {
// 'line-color': '#0047AB',
// 'line-width': 0.8
// }
// });
 
// When a click event occurs on a feature in the states layer,
// open a popup at the location of the click, with description
// HTML from the click event's properties.

let ClickStage = -1; 

// markers saved here
let currentMarkers=[];
let FromText;
let ToText;
//const start = [33.2872, 34.9447];

// create a function to make a directions request
async function getRoute(start, end) {
  // make a directions request using cycling profile
  // an arbitrary start will always be the same
  // only the end or destination will change
  const query = await fetch(
    `https://api.mapbox.com/directions/v5/mapbox/cycling/${start[0]},${start[1]};${end[0]},${end[1]}?steps=false&geometries=geojson&access_token=${mapboxgl.accessToken}`,
    { method: 'GET' }
  );
  const json = await query.json();
  const data = json.routes[0];
  const route = data.geometry.coordinates;
  const geojson = {
    type: 'Feature',
    properties: {},
    geometry: {
      type: 'LineString',
      coordinates: route
    }
  };
  // if the route already exists on the map, we'll reset it using setData
  if (map.getSource('route')) {
    map.getSource('route').setData(geojson);
  }
  // otherwise, we'll make a new request
  else {
    map.addLayer({
      id: 'route',
      type: 'line',
      source: {
        type: 'geojson',
        data: geojson
      },
      layout: {
        'line-join': 'round',
        'line-cap': 'round'
      },
      paint: {
        'line-color': '#3887be',
        'line-width': 5,
        'line-opacity': 0.75
      }
    });
  }
  // add turn instructions here at the end
}

async function reverseGeocode(coords) {


  const tag = ClickStage <= 0 ? `From` :  `To`

  // remove markers 
  if (ClickStage === 0 && currentMarkers!==null) {
          for (var i = currentMarkers.length - 1; i >= 0; i--) {
            currentMarkers[i].remove();
          }
      }

  const query = await fetch(
    `https://api.mapbox.com/geocoding/v5/mapbox.places/${coords[0]},${coords[1]}.json?country=cy&limit=1&types=address&language=en&access_token=${mapboxgl.accessToken}`,
    { method: 'GET' }
  );
  const json = await query.json();
  const data = json.features[0];
  const place_name_en = data.place_name_en;
  const text_en = data.text_en;


   const marker = new mapboxgl.Marker()
      .setLngLat(coords)
      .addTo(map)
      .setPopup(new mapboxgl.Popup().setHTML(`${tag}:<br> ${place_name_en}`).addTo(map)); // add popup
  
      // save marker into currentMarkers
      currentMarkers.push(marker);


    document.getElementById(tag).value = place_name_en;

    return text_en;
}

map.on('load', () => {
  // make an initial directions request that

  let start = [];
  let end = [];

  // this is where the code from the next step will go
});

map.on('click', (event) => {
  const coords = Object.keys(event.lngLat).map((key) => event.lngLat[key]);

  console.log(ClickStage);
if (ClickStage <= 0) {
  
  start = coords;

  const StartLayer = {
    type: 'FeatureCollection',
    features: [
      {
        type: 'Feature',
        properties: {},
        geometry: {
          type: 'Point',
          coordinates: start
        }
      }
    ]
  };

  // Add starting point to the map

  if (map.getLayer('start')) {
    map.getSource('start').setData(StartLayer);
  } else {

    // map.addLayer({
    // id: 'start',
    // type: 'circle',
    // source: {
    //   type: 'geojson',
    //   data: {
    //     type: 'FeatureCollection',
    //     features: [
    //       {
    //         type: 'Feature',
    //         properties: {},
    //         geometry: {
    //           type: 'Point',
    //           coordinates: start
    //         }
    //       }
    //     ]
    //   }
    // },
    // paint: {
    //   'circle-radius': 10,
    //   'circle-color': '#3887be'
    // }
    // });

  }

  reverseGeocode(start).then(
    function(result) {FromText = result}
  )
  
  ClickStage = 1;

} else {

  end = coords;

  const endLayer = {
    type: 'FeatureCollection',
    features: [
      {
        type: 'Feature',
        properties: {},
        geometry: {
          type: 'Point',
          coordinates: end
        }
      }
    ]
  };
  if (map.getLayer('end')) {
    map.getSource('end').setData(endLayer);
  } else {
    // map.addLayer({
    //   id: 'end',
    //   type: 'circle',
    //   source: {
    //     type: 'geojson',
    //     data: {
    //       type: 'FeatureCollection',
    //       features: [
    //         {
    //           type: 'Feature',
    //           properties: {},
    //           geometry: {
    //             type: 'Point',
    //             coordinates: end
    //           }
    //         }
    //       ]
    //     }
    //   },
    //   paint: {
    //     'circle-radius': 10,
    //     'circle-color': '#f30'
    //   }
    // });
  }

  getRoute(start, end);

  
  reverseGeocode(end).then(
    function(result) {ToText = result}
  )
  

    ClickStage = 0;
}
  
});




// map.on('click', 'districts-layer', (e) => {
// new mapboxgl.Popup()
// .setLngLat(e.lngLat)
// .setHTML(e.features[0].properties.district)
// .addTo(map);

// console.log(e.features[0].properties.district);







// });
 
// // Change the cursor to a pointer when
// // the mouse is over the states layer.
// map.on('mouseenter', 'districts-layer', () => {
// map.getCanvas().style.cursor = 'pointer';
// });
 
// // Change the cursor back to a pointer
// // when it leaves the states layer.
// map.on('mouseleave', 'districts-layer', () => {
// map.getCanvas().style.cursor = '';
// });
// });

// Handle form submit
const form  = document.getElementById('form');

form.addEventListener('submit', (event) => {
    // handle the form data
    event.preventDefault();

    const today = new Date();

    todayDate = `${today.getDate()}/${today.getMonth()+1}/${today.getFullYear()}`;
    nowHour  =  today.getHours();
    nowMinute = (today.getMinutes() + 10) % 60;
   
  console.log(`https://www.cyprusbybus.com/search.aspx?from=${encodeURIComponent(FromText)}&fromt=-1&to=${encodeURIComponent(ToText)}&tot=-1&s=1&dd=${todayDate}&h=${nowHour}&m=${nowMinute}`);
  window.open(`https://www.cyprusbybus.com/search.aspx?from=${encodeURIComponent(FromText)}&fromt=-1&to=${encodeURIComponent(ToText)}&tot=-1&s=1&dd=${todayDate}&h=${nowHour}&m=${nowMinute}`)
    

});





</script>
</html>